{% extends 'core/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/developer_trainee_start_exam.css' %}">
{% endblock %}

{% block content %}
<div class="admin-dashboard-header">
  <div class="greeting">
    <div style="display: flex; gap: 10px;">
      <div style="margin-top: 20px;">
        <h3>{{ greeting }}!!!</h3>
        <p>It's {{ today|date:"l, d F Y" }}</p>
      </div>
    </div>
  </div>

  <div class="icon-group">
    <div class="login-icon">
      <a href="{% url 'admin_logout' %}">
        <img src="{% static 'images/logout.jpeg' %}" alt="Logout" title="logout" />
      </a>
    </div>
  </div>
</div>

<div class="container mt-5">
  <!-- <video hidden id="webcam" autoplay playsinline width="320" height="240" style="border: 2px solid #000;"></video> -->
<!-- <video id="video" width="320" height="240" autoplay muted></video>
<canvas id="canvas" width="320" height="240" style="display: none;"></canvas> -->

<video id="cameraPreview" autoplay muted playsinline style="width:300px;border:2px solid #555;border-radius:10px;"></video>
  <h2>{{ exam.title }}</h2>
  <div id="timer" style="font-size: 24px; color: red;"></div>

  <form method="POST" id="examForm" enctype="multipart/form-data" action="{% url 'developer_trainee_submit_exam' exam.id %}">
    {% csrf_token %}
<!-- hidden video file input (auto-filled by JS) -->
    <input type="file" name="video" id="videoInput" accept="video/*" hidden>
        {% for question in questions %}
      <div class="mb-4">
        <p><strong>Q{{ forloop.counter }}. {{ question.question_text }}</strong></p>
        <div>
          <input type="radio" name="q{{ question.id }}" value="A" required> {{ question.option_a }}<br>
          <input type="radio" name="q{{ question.id }}" value="B"> {{ question.option_b }}<br>
          <input type="radio" name="q{{ question.id }}" value="C"> {{ question.option_c }}<br>
          <input type="radio" name="q{{ question.id }}" value="D"> {{ question.option_d }}
        </div>
      </div>
    {% endfor %}
    <button type="submit" class="btn btn-success">Submit Exam</button>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let mediaRecorder;
    let recordedChunks = [];
    const examForm = document.getElementById('examForm');
    const cameraPreview = document.getElementById('cameraPreview');
    const videoInput = document.getElementById('videoInput');

    // üé• Start recording
    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            cameraPreview.srcObject = stream;
            recordedChunks = [];

            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) recordedChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                console.log("üé¨ Recording stopped event triggered");
                const blob = new Blob(recordedChunks, { type: "video/webm" });
                const file = new File([blob], "exam_recording.webm", { type: "video/webm" });

                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                videoInput.files = dataTransfer.files;

                console.log("‚úÖ Video attached to form, submitting...");
                examForm.submit();
            };

            mediaRecorder.start();
            console.log("üé• Recording started...");
        } catch (err) {
            console.error("üö´ Camera access denied:", err);
            alert("Camera access required to continue the exam.");
        }
    }

    // üß± Stop recording & submit after delay
    function stopRecordingAndSubmit() {
      debugger
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
            console.log("üõë Stopping recording...");
            mediaRecorder.stop();

            // Add safeguard timeout in case 'onstop' doesn't fire quickly
            setTimeout(() => {
                if (videoInput.files.length === 0) {
                    console.warn("‚ö†Ô∏è onstop not triggered in time, submitting anyway...");
                    examForm.submit();
                }
            }, 2000);
        } else {
            console.log("‚ö†Ô∏è MediaRecorder inactive or missing, submitting form directly.");
            examForm.submit();
        }
    }

    // ‚úÖ Start recording on load
    startRecording();

    // ‚úÖ Stop recording when form is submitted
    examForm.addEventListener('submit', function(e) {
        e.preventDefault();
        stopRecordingAndSubmit();
    });

      // Expose globally
    window.stopRecordingAndSubmit = stopRecordingAndSubmit;
});
</script>




<script>
 
  const examDurationMin = Number("{{ exam_duration|default:1 }}");
  let duration = examDurationMin * 60;

  const form = document.getElementById('examForm');
  const timerDisplay = document.getElementById('timer');
  let examSubmitted = false;
  let countdownId = null;

  // Render mm:ss
  function renderTime(sec) {
    const m = String(Math.floor(sec / 60)).padStart(2, '0');
    const s = String(sec % 60).padStart(2, '0');
    timerDisplay.textContent = `Time Left: ${m}:${s}`;
  }

  // Submit helper (used by timeout / manual / navigation)
  function submitExam(reason) {
    if (examSubmitted) return;
    examSubmitted = true;
    // Allow normal form submit when we're still on the page
    try { form.submit(); } catch(e) {}
  }

  // Auto submit at time up
  function startTimer() {
    renderTime(duration);
    countdownId = setInterval(() => {
      duration -= 1;
      renderTime(duration);
      if (duration <= 0) {
        clearInterval(countdownId);
        alert("Time's up! Your exam will be submitted automatically.");
        submitExam('timeout');
      }
    }, 1000);
  }

 

  // Intercept internal link clicks to confirm and auto-submit
  document.addEventListener('click', function (e) {
    const a = e.target.closest('a');
    if (!a) return;
    const href = a.getAttribute('href');
    if (!href) return;

    if (!examSubmitted) {
      e.preventDefault();
      const ok = confirm("Exam in progress. Leaving will submit your exam automatically. Continue?");
      if (ok) {
        // background submit
        try {
          const fd = new FormData(form);
          const body = new URLSearchParams(fd).toString();
          const blob = new Blob([body], { type: 'application/x-www-form-urlencoded;charset=UTF-8' });
          navigator.sendBeacon(form.action, blob);
        } catch (err) {}
        // then navigate
        window.location.href = href;
      }
    }
  });

  // If user submits manually, mark as submitted to stop warnings
  form.addEventListener('submit', function () {
    examSubmitted = true;
    if (countdownId) clearInterval(countdownId);
  });

  // Start the timer when page is ready
  window.addEventListener('load', startTimer);
</script>

<!-- <script>
  const video = document.getElementById('webcam');

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
    } catch (error) {
      alert("Camera access denied or not available.");
      console.error("Camera error:", error);
    }
  }

  window.onload = startCamera;
</script> -->
<script>
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  // Start camera
  navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
    video.srcObject = stream;
  });

  function captureAndSendImage() {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    let dataUrl = canvas.toDataURL("image/jpeg");

    

    fetch("/save-snapshot/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({ image: dataUrl }),
    });
  }

  // Take snapshot every 30 seconds
  setInterval(captureAndSendImage, 30000);
</script>




<script>
document.addEventListener('DOMContentLoaded', function() {
    const examId = parseInt("{{ exam.id }}");
    const examForm = document.getElementById('examForm');
    let examEnded = false;

   
function autoSubmitExam(reason) {
  debugger
   
                 if (examEnded) return;
        examEnded = true;

        alert("‚ö†Ô∏è Exam auto-submitted due to: " + reason);

        if (typeof stopRecordingAndSubmit === "function") {
            console.log("üé• Stopping recording before submitting exam...");
            stopRecordingAndSubmit();  // ‚úÖ call from the other script
        } else {
            console.warn("‚ö†Ô∏è stopRecordingAndSubmit not available, redirecting directly.");
            window.location.href = `/trainee/submit_exam/${examId}/`;
        }

}

    // üö´ 1. Prevent refresh or closing tab
    // window.addEventListener("beforeunload", function (e) {
    //     e.preventDefault();
    //     e.returnValue = "‚ö†Ô∏è You are leaving the exam. It will be auto-submitted!";
    //     autoSubmitExam("Page refresh or tab closed");
    //     return e.returnValue;
    // });

    // üö´ 2. Detect tab switch (when page loses focus)
    // document.addEventListener("visibilitychange", function() {
    //     if (document.hidden) {
    //         autoSubmitExam("Switching to another tab or app");
    //     }
    // });

    // üö´ 3. Detect mouse leaving browser window
    document.addEventListener('mouseout', function(e) {
        if (!e.toElement && !e.relatedTarget) {
            autoSubmitExam("Mouse left exam window");
        }
    });

    // üö´ 4. Disable right-click
    document.addEventListener('contextmenu', e => e.preventDefault());

    // üö´ 5. Optional: Disable key shortcuts like Ctrl+T, Ctrl+W, Alt+Tab
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey && (e.key === 't' || e.key === 'w')) || e.altKey) {
            e.preventDefault();
            autoSubmitExam("Keyboard shortcut attempt");
        }
    });
});
</script>







{% endblock %}


